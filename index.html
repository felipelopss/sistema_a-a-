<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Açaí do Felps - Sistema de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .menu-active { background-color: #4c1d95; color: white; }
        .form-container { max-width: 400px; }
        .filter-checkbox:checked + label {
            background-color: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        .dashboard-period-btn.active {
            background-color: #8b5cf6;
            color: white;
        }
        .product-tab.active {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 z-50 flex items-center justify-center hidden">
        <i class="fas fa-spinner fa-spin text-purple-600 text-5xl"></i>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Confirmar Exclusão</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Você tem certeza que deseja apagar este registro? Esta ação não pode ser desfeita.</p>
                </div>
                <div class="items-center px-4 py-3 sm:flex sm:flex-row-reverse">
                    <button id="modal-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Apagar
                    </button>
                    <button id="modal-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Opções de PDF -->
    <div id="pdf-options-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-purple-100">
                    <i class="fas fa-file-pdf text-2xl text-purple-600"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Escolha o Relatório para Baixar</h3>
                <div class="mt-4 px-7 py-3 space-y-3">
                    <button data-period="diario" class="pdf-download-option w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Relatório Diário</button>
                    <button data-period="semanal" class="pdf-download-option w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Relatório Semanal</button>
                    <button data-period="mensal" class="pdf-download-option w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Relatório Mensal</button>
                    <button data-period="anual" class="pdf-download-option w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Relatório Anual</button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="pdf-options-cancel-btn" class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container de Autenticação -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full form-container">
            <div id="login-form-container">
                <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                    <img src="https://i.imgur.com/WiDeQGb.png" alt="Logotipo" class="w-24 h-24 mx-auto mb-4">
                    <h1 class="text-3xl font-bold text-purple-700 mb-2">Açaí do Felps</h1>
                    <p class="text-gray-500 mb-6">Acesse sua conta</p>
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="Seu e-mail" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        <input type="password" id="login-password" placeholder="Sua senha" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">Entrar</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-sm mt-2 h-4"></p>
                    <div class="mt-4 text-sm">
                        <a href="#" id="show-reset" class="text-purple-600 hover:underline">Esqueci a senha</a>
                    </div>
                </div>
            </div>
            <div id="reset-form-container" class="hidden">
                <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-purple-700 mb-2">Redefinir Senha</h1><p class="text-gray-500 mb-6">Enviaremos um link para o seu e-mail.</p>
                    <form id="reset-form" class="space-y-4">
                        <input type="email" id="reset-email" placeholder="Seu e-mail de cadastro" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">Enviar Link</button>
                    </form>
                    <p id="reset-message" class="text-green-600 text-sm mt-2 h-4"></p><a href="#" id="show-login-from-reset" class="mt-4 text-sm text-purple-600 hover:underline">Voltar para o Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="hidden">
        <div class="relative min-h-screen md:flex">
            <!-- Overlay para menu mobile -->
            <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
            
            <!-- Menu Lateral -->
            <aside id="sidebar" class="w-64 bg-purple-800 text-purple-100 flex-shrink-0 flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-40">
                <div class="h-20 flex items-center justify-center px-4 space-x-2">
                    <img src="https://i.imgur.com/WiDeQGb.png" alt="Logotipo" class="w-10 h-10">
                    <span class="text-xl font-bold">Açaí do Felps</span>
                </div>
                <nav class="flex-1 px-4 space-y-2">
                    <a href="#" data-page="dashboard" class="menu-item flex items-center px-4 py-2 rounded-lg hover:bg-purple-700 menu-active"><i class="fas fa-wallet w-6 mr-3"></i>Dashboard</a>
                    <a href="#" data-page="produtos" class="menu-item flex items-center px-4 py-2 rounded-lg hover:bg-purple-700"><i class="fas fa-box-open w-6 mr-3"></i>Produtos</a>
                    <a href="#" data-page="registros" class="menu-item flex items-center px-4 py-2 rounded-lg hover:bg-purple-700"><i class="fas fa-edit w-6 mr-3"></i>Registros</a>
                    <a href="#" data-page="relatorios" class="menu-item flex items-center px-4 py-2 rounded-lg hover:bg-purple-700"><i class="fas fa-file-alt w-6 mr-3"></i>Relatórios</a>
                </nav>
                <div class="p-4 border-t border-purple-700"><p id="user-email" class="text-sm truncate" title="email"></p><button id="logout-btn" class="w-full mt-2 text-left flex items-center px-4 py-2 rounded-lg hover:bg-purple-700"><i class="fas fa-sign-out-alt w-6 mr-3"></i>Sair</button></div>
            </aside>

            <!-- Conteúdo Principal -->
            <div class="flex-1 flex flex-col">
                <!-- Header Mobile -->
                <header class="md:hidden bg-white shadow-md p-4 flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <img src="https://i.imgur.com/WiDeQGb.png" alt="Logotipo" class="w-9 h-9">
                        <h1 class="text-xl font-bold text-purple-700">Açaí do Felps</h1>
                    </div>
                    <button id="mobile-menu-button" class="text-gray-700">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </header>
                <main class="flex-1 p-4 sm:p-6 lg:p-10 overflow-y-auto">
                    <!-- Página: Dashboard -->
                    <section id="dashboard-page" class="page-content space-y-6">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Dashboard Visual</h1>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-xl font-semibold mb-4 text-gray-700">Filtrar por Período</h2>
                            <div id="dashboard-period-filter" class="flex flex-wrap items-center gap-2">
                                <button data-period="hoje" class="dashboard-period-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300">Hoje</button>
                                <button data-period="semana" class="dashboard-period-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300 active">Esta Semana</button>
                                <button data-period="mes" class="dashboard-period-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300">Este Mês</button>
                                <button data-period="ano" class="dashboard-period-btn px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300">Este Ano</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                             <h2 class="text-xl font-semibold mb-4 text-gray-700">Resumo do Período: <span id="dashboard-period-label" class="text-purple-600">Esta Semana</span></h2>
                             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                                <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm text-green-700">Total Vendas</p><p id="dashboard-vendas" class="text-2xl font-bold text-green-800">R$ 0,00</p></div>
                                <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm text-red-700">Total Despesas</p><p id="dashboard-despesas" class="text-2xl font-bold text-red-800">R$ 0,00</p></div>
                                <div class="bg-purple-100 p-4 rounded-lg"><p class="text-sm text-purple-700">Faturamento (Lucro)</p><p id="dashboard-faturamento" class="text-2xl font-bold text-purple-800">R$ 0,00</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-xl font-semibold mb-4 text-gray-700">Detalhes de Vendas do Período</h2>
                            <div class="overflow-x-auto max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Data/Hora</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Itens</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pagamento</th>
                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dashboard-vendas-detalhadas"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Página: Produtos -->
                    <section id="produtos-page" class="page-content hidden space-y-6">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Cadastro de Produtos</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 id="form-produto-title" class="text-xl font-semibold mb-4 text-purple-700">Novo Produto</h2>
                                <form id="form-produto" class="space-y-4">
                                    <input type="hidden" id="produto-id-cadastro">
                                    <div>
                                        <label for="produto-nome-cadastro" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                                        <input type="text" id="produto-nome-cadastro" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div>
                                        <label for="produto-preco-cadastro" class="block text-sm font-medium text-gray-700">Preço Padrão (R$)</label>
                                        <input type="number" step="0.01" id="produto-preco-cadastro" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div>
                                        <label for="produto-categoria-cadastro" class="block text-sm font-medium text-gray-700">Categoria</label>
                                        <select id="produto-categoria-cadastro" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                            <option value="" disabled selected>Selecione a categoria</option>
                                            <option>Açaí</option>
                                            <option>Adicionais</option>
                                            <option>Sorvete</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <button type="submit" id="form-produto-submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Cadastrar Produto</button>
                                        <button type="button" id="form-produto-cancel" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 hidden">Cancelar Edição</button>
                                    </div>
                                </form>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-semibold mb-4 text-gray-700">Produtos Cadastrados</h2>
                                <div class="border-b border-gray-200 mb-4">
                                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                        <button data-category="Açaí" class="product-tab whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm active">Açaí</button>
                                        <button data-category="Adicionais" class="product-tab whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700">Adicionais</button>
                                        <button data-category="Sorvete" class="product-tab whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700">Sorvete</button>
                                    </nav>
                                </div>
                                <div class="overflow-y-auto max-h-80">
                                    <div id="lista-produtos-acai" class="product-list"></div>
                                    <div id="lista-produtos-adicionais" class="product-list hidden"></div>
                                    <div id="lista-produtos-sorvete" class="product-list hidden"></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Página: Registros -->
                    <section id="registros-page" class="page-content hidden">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Lançamentos</h1>
                        <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                            <strong class="font-bold">Sucesso!</strong>
                            <span class="block sm:inline">Registro salvo.</span>
                        </div>
                        <div class="mb-6">
                            <div class="border-b border-gray-200">
                                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                    <button id="tab-venda-btn" class="registro-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-purple-600 border-purple-600">
                                        <i class="fas fa-plus-circle mr-2"></i> Nova Venda
                                    </button>
                                    <button id="tab-despesa-btn" class="registro-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                                        <i class="fas fa-minus-circle mr-2"></i> Nova Despesa
                                    </button>
                                </nav>
                            </div>
                        </div>
                        <div class="max-w-2xl mx-auto">
                            <div id="tab-venda-content" class="registro-tab-content">
                                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg space-y-6">
                                    <!-- Formulário para adicionar item -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="acai-select" class="block text-sm font-medium text-gray-700">Açaís</label>
                                            <select id="acai-select" class="produto-categoria-select mt-1 w-full p-2 border border-gray-300 rounded-lg"></select>
                                        </div>
                                        <div>
                                            <label for="adicionais-select" class="block text-sm font-medium text-gray-700">Adicionais</label>
                                            <select id="adicionais-select" class="produto-categoria-select mt-1 w-full p-2 border border-gray-300 rounded-lg"></select>
                                        </div>
                                        <div>
                                            <label for="sorvete-select" class="block text-sm font-medium text-gray-700">Sorvetes</label>
                                            <select id="sorvete-select" class="produto-categoria-select mt-1 w-full p-2 border border-gray-300 rounded-lg"></select>
                                        </div>
                                    </div>
                                    <div class="flex items-end gap-4">
                                        <div class="flex-grow">
                                            <label for="item-quantidade" class="block text-sm font-medium text-gray-700">Quantidade</label>
                                            <input type="number" id="item-quantidade" value="1" min="1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                        </div>
                                        <button id="add-item-btn" type="button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 h-10">Adicionar</button>
                                    </div>
                                    
                                    <!-- Carrinho / Pedido Atual -->
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-800 mb-2">Pedido Atual</h3>
                                        <div id="order-items-list" class="space-y-2"></div>
                                        <div class="mt-4 pt-4 border-t flex justify-between items-center text-xl font-bold">
                                            <span>Total do Pedido:</span>
                                            <span id="order-total">R$ 0,00</span>
                                        </div>
                                    </div>

                                    <!-- Finalizar Venda -->
                                    <form id="form-venda" class="space-y-6">
                                        <div>
                                            <label for="forma-pagamento" class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                                            <select id="forma-pagamento" class="w-full p-2 border border-gray-300 rounded-lg" required><option value="" disabled selected>Selecione</option><option>Dinheiro</option><option>Pix</option><option>Cartão</option></select>
                                        </div>
                                        <button type="submit" class="w-full flex justify-center items-center bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-transform transform hover:scale-105"><i class="fas fa-check-circle mr-2"></i> Finalizar e Registrar Venda</button>
                                    </form>
                                </div>
                            </div>
                            <div id="tab-despesa-content" class="registro-tab-content hidden">
                                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                                    <form id="form-despesa" class="space-y-6">
                                        <div>
                                            <label for="despesa-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição da Despesa</label>
                                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-tag text-gray-400"></i></div><input type="text" id="despesa-descricao" class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ex: Compra de frutas" required></div>
                                        </div>
                                        <div>
                                            <label for="despesa-valor" class="block text-sm font-medium text-gray-700 mb-1">Valor da Despesa (R$)</label>
                                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">R$</span></div><input type="number" id="despesa-valor" step="0.01" class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="50.00" required></div>
                                        </div>
                                        <button type="submit" class="w-full flex justify-center items-center bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105"><i class="fas fa-check-circle mr-2"></i> Registrar Despesa</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Página: Relatórios -->
                    <section id="relatorios-page" class="page-content hidden space-y-6">
                         <div class="flex flex-wrap justify-between items-center gap-4">
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Relatórios</h1>
                            <button id="download-pdf-btn" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-800"><i class="fas fa-file-pdf mr-2"></i>Baixar PDF</button>
                        </div>

                        <div id="pdf-content" class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-semibold mb-4 text-gray-700">Resumo de Faturamento</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                                    <div class="bg-purple-100 p-4 rounded-lg"><p class="text-sm text-purple-700">Faturamento da Semana</p><p id="faturamento-semana" class="text-2xl font-bold text-purple-800">R$ 0,00</p></div>
                                    <div class="bg-purple-100 p-4 rounded-lg"><p class="text-sm text-purple-700">Faturamento do Mês</p><p id="faturamento-mes" class="text-2xl font-bold text-purple-800">R$ 0,00</p></div>
                                    <div class="bg-purple-100 p-4 rounded-lg"><p class="text-sm text-purple-700">Faturamento do Ano</p><p id="faturamento-ano" class="text-2xl font-bold text-purple-800">R$ 0,00</p></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-semibold mb-4 text-gray-700">Relatório Detalhado</h2>
                                <div class="flex flex-wrap items-start gap-x-8 gap-y-4">
                                    <div>
                                        <p class="font-medium mb-2">Período:</p>
                                        <div id="period-filter" class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                                            <div><input type="radio" id="period-semanal" name="period" value="semanal" checked><label for="period-semanal" class="ml-2 cursor-pointer">Semanal</label></div>
                                            <div><input type="radio" id="period-mensal" name="period" value="mensal"><label for="period-mensal" class="ml-2 cursor-pointer">Mensal</label></div>
                                            <div><input type="radio" id="period-anual" name="period" value="anual"><label for="period-anual" class="ml-2 cursor-pointer">Anual</label></div>
                                        </div>
                                    </div>
                                    <div id="dias-semana-container">
                                        <p class="font-medium mb-2">Dias da semana:</p>
                                        <div id="dias-semana-filter" class="flex flex-wrap gap-2"></div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button id="filter-btn" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Aplicar Filtro</button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-semibold mb-4 text-purple-700">Vendas (<span id="vendas-periodo-label"></span>)</h2>
                                <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-2 text-left">Data/Hora</th><th class="px-4 py-2 text-left">Itens</th><th class="px-4 py-2 text-left">Pagamento</th><th class="px-4 py-2 text-right">Valor Total</th><th class="px-4 py-2 text-center">Ações</th></tr></thead><tbody id="vendas-detalhadas-table"></tbody></table></div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-semibold mb-4 text-red-600">Despesas (<span id="despesas-periodo-label"></span>)</h2>
                                <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-2 text-left">Data/Hora</th><th class="px-4 py-2 text-left">Descrição</th><th class="px-4 py-2 text-right">Valor</th><th class="px-4 py-2 text-center">Ações</th></tr></thead><tbody id="despesas-detalhadas-table"></tbody></table></div>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Imports e Configuração do Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIGURAÇÃO DO FIREBASE - COLE SUAS CHAVES AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyCqP99onLtbTZT_wKARPdHtqKdtl7UtFAA",
            authDomain: "sistema-acai-f92c4.firebaseapp.com",
            projectId: "sistema-acai-f92c4",
            storageBucket: "sistema-acai-f92c4.appspot.com",
            messagingSenderId: "379807353421",
            appId: "1:379807353421:web:978358fb8b97a576676a04"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "sistema-acai-f92c4";
        const { jsPDF } = window; 

        // --- Variáveis Globais ---
        let userId = null;
        let unsubVendas = () => {};
        let unsubDespesas = () => {};
        let unsubProdutos = () => {};
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const modal = document.getElementById('confirmation-modal');
        let deleteFunction = null;

        // --- Lógica de Autenticação ---
        const loginForm = document.getElementById('login-form');
        const resetForm = document.getElementById('reset-form');
        loginForm.addEventListener('submit', e => { e.preventDefault(); loadingOverlay.classList.remove('hidden'); signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value).catch(err => document.getElementById('login-error').textContent = "E-mail ou senha inválidos.").finally(() => loadingOverlay.classList.add('hidden')); });
        resetForm.addEventListener('submit', e => { e.preventDefault(); sendPasswordResetEmail(auth, resetForm['reset-email'].value).then(() => document.getElementById('reset-message').textContent = "Link enviado!").catch(err => document.getElementById('reset-message').textContent = "Erro ao enviar."); });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        const authForms = { login: document.getElementById('login-form-container'), reset: document.getElementById('reset-form-container') };
        const showAuthForm = (formName) => Object.keys(authForms).forEach(key => authForms[key].classList.toggle('hidden', key !== formName));
        document.getElementById('show-reset').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('reset'); });
        document.getElementById('show-login-from-reset').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });

        // --- Controlador Principal ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-email').textContent = user.email;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setupFilters();
                setupDashboard();
                listenToData(userId);
            } else {
                userId = null;
                unsubVendas(); unsubDespesas(); unsubProdutos();
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
        
        // --- Lógica de Dados (Firestore) ---
        function listenToData(uid) {
            loadingOverlay.classList.remove('hidden');
            const vendasRef = collection(db, `artifacts/${appId}/users/${uid}/vendas`);
            const despesasRef = collection(db, `artifacts/${appId}/users/${uid}/despesas`);
            const produtosRef = collection(db, `artifacts/${appId}/users/${uid}/produtos`);
            
            unsubVendas = onSnapshot(query(vendasRef, orderBy("timestamp", "desc")), snap => {
                const vendasData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(vendasData, null, null); 
            });

            unsubDespesas = onSnapshot(query(despesasRef, orderBy("timestamp", "desc")), snap => {
                const despesasData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(null, despesasData, null);
            });

            unsubProdutos = onSnapshot(query(produtosRef, orderBy("nome", "asc")), snap => {
                const produtosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(null, null, produtosData);
            });
        }
        
        function showSuccessMessage() {
            const successMessage = document.getElementById('success-message');
            successMessage.classList.remove('hidden');
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 3000);
        }

        document.getElementById('form-produto').addEventListener('submit', async e => {
            e.preventDefault();
            const nome = document.getElementById('produto-nome-cadastro').value;
            const preco = parseFloat(document.getElementById('produto-preco-cadastro').value);
            const categoria = document.getElementById('produto-categoria-cadastro').value;
            const id = document.getElementById('produto-id-cadastro').value;

            if (nome && !isNaN(preco) && categoria && userId) {
                loadingOverlay.classList.remove('hidden');
                try {
                    if (id) { // Modo Edição
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/produtos`, id);
                        await updateDoc(docRef, { nome, preco, categoria });
                    } else { // Modo Cadastro
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/produtos`), { nome, preco, categoria });
                    }
                    resetProdutoForm();
                } catch (error) {
                    console.error("Erro ao salvar produto:", error);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }
        });

        // Lógica do Carrinho de Vendas
        let currentOrderItems = [];
        const addItemBtn = document.getElementById('add-item-btn');
        const itemQuantidade = document.getElementById('item-quantidade');
        const orderItemsList = document.getElementById('order-items-list');
        const orderTotalEl = document.getElementById('order-total');

        function renderCurrentOrder() {
            orderItemsList.innerHTML = '';
            let total = 0;
            if (currentOrderItems.length === 0) {
                orderItemsList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum item no pedido.</p>';
            } else {
                currentOrderItems.forEach((item, index) => {
                    orderItemsList.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                            <span>${item.quantidade}x ${item.nome}</span>
                            <span>${formatCurrency(item.preco * item.quantidade)}</span>
                            <button class="remove-item-btn text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-times-circle"></i></button>
                        </div>
                    `;
                    total += item.preco * item.quantidade;
                });
            }
            orderTotalEl.textContent = formatCurrency(total);
        }

        addItemBtn.addEventListener('click', () => {
            const selects = document.querySelectorAll('.produto-categoria-select');
            let selectedOption = null;
            let selectedSelect = null;

            selects.forEach(select => {
                if (select.value) {
                    selectedOption = select.options[select.selectedIndex];
                    selectedSelect = select;
                }
            });

            if (!selectedOption) {
                alert('Por favor, selecione um produto.');
                return;
            }

            const nome = selectedOption.value;
            const preco = parseFloat(selectedOption.dataset.price);
            const quantidade = parseInt(itemQuantidade.value);

            if (nome && !isNaN(preco) && quantidade > 0) {
                currentOrderItems.push({ nome, preco, quantidade });
                renderCurrentOrder();
                selects.forEach(s => s.selectedIndex = 0);
                itemQuantidade.value = 1;
            }
        });

        orderItemsList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-item-btn')) {
                const index = e.target.closest('.remove-item-btn').dataset.index;
                currentOrderItems.splice(index, 1);
                renderCurrentOrder();
            }
        });

        document.getElementById('form-venda').addEventListener('submit', async e => { 
            e.preventDefault(); 
            const formaPagamento = e.target['forma-pagamento'].value;
            
            if (currentOrderItems.length === 0) {
                alert('Adicione pelo menos um item ao pedido.');
                return;
            }
            if (!formaPagamento) {
                alert('Selecione a forma de pagamento.');
                return;
            }

            const total = currentOrderItems.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            
            loadingOverlay.classList.remove('hidden');
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/vendas`), { 
                    total: total,
                    formaPagamento: formaPagamento,
                    items: currentOrderItems,
                    timestamp: serverTimestamp() 
                }); 
                
                currentOrderItems = [];
                renderCurrentOrder();
                e.target.reset(); 
                showSuccessMessage();
            } catch (error) {
                console.error("Erro ao adicionar venda:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });
        
        document.getElementById('form-despesa').addEventListener('submit', async e => { 
            e.preventDefault(); 
            const descricao = e.target['despesa-descricao'].value; 
            const valor = parseFloat(e.target['despesa-valor'].value); 
            if (descricao && !isNaN(valor) && userId) { 
                loadingOverlay.classList.remove('hidden');
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/despesas`), { descricao, valor, timestamp: serverTimestamp() }); 
                    e.target.reset(); 
                    showSuccessMessage();
                } catch (error) {
                    console.error("Erro ao adicionar despesa:", error);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            } 
        });

        async function deleteItem(type, id) {
            if (!userId) return;
            loadingOverlay.classList.remove('hidden');
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${type}`, id);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Erro ao apagar item:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // --- Lógica de Renderização ---
        let currentVendas = [];
        let currentDespesas = [];
        let currentProdutos = [];

        function renderAll(vendas, despesas, produtos) {
            if (vendas) currentVendas = vendas;
            if (despesas) currentDespesas = despesas;
            if (produtos) currentProdutos = produtos;
            
            renderFaturamentoSummary(currentVendas, currentDespesas);
            renderDashboard(currentVendas, currentDespesas);
            renderProdutosPage(currentProdutos);
            document.getElementById('filter-btn').click(); 
            loadingOverlay.classList.add('hidden');
        }

        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        function renderFaturamentoSummary(vendas, despesas) {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            const vendasSemana = vendas.filter(v => v.timestamp && v.timestamp.toDate() >= startOfWeek).reduce((sum, v) => sum + v.total, 0);
            const despesasSemana = despesas.filter(d => d.timestamp && d.timestamp.toDate() >= startOfWeek).reduce((sum, d) => sum + d.valor, 0);
            document.getElementById('faturamento-semana').textContent = formatCurrency(vendasSemana - despesasSemana);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const vendasMes = vendas.filter(v => v.timestamp && v.timestamp.toDate() >= startOfMonth).reduce((sum, v) => sum + v.total, 0);
            const despesasMes = despesas.filter(d => d.timestamp && d.timestamp.toDate() >= startOfMonth).reduce((sum, d) => sum + d.valor, 0);
            document.getElementById('faturamento-mes').textContent = formatCurrency(vendasMes - despesasMes);

            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const vendasAno = vendas.filter(v => v.timestamp && v.timestamp.toDate() >= startOfYear).reduce((sum, v) => sum + v.total, 0);
            const despesasAno = despesas.filter(d => d.timestamp && d.timestamp.toDate() >= startOfYear).reduce((sum, d) => sum + d.valor, 0);
            document.getElementById('faturamento-ano').textContent = formatCurrency(vendasAno - despesasAno);
        }

        // --- Lógica do Dashboard ---
        function setupDashboard() {
            const periodButtons = document.querySelectorAll('.dashboard-period-btn');
            periodButtons.forEach(button => {
                button.addEventListener('click', () => {
                    periodButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderDashboard(currentVendas, currentDespesas);
                });
            });
        }

        function renderDashboard(vendas, despesas) {
            const activePeriod = document.querySelector('.dashboard-period-btn.active').dataset.period;
            document.getElementById('dashboard-period-label').textContent = document.querySelector('.dashboard-period-btn.active').textContent;
            
            let startDate, endDate;
            const now = new Date();

            switch (activePeriod) {
                case 'hoje':
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'semana':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'mes':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'ano':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
            }

            const filteredVendas = vendas.filter(v => v.timestamp && v.timestamp.toDate() >= startDate && v.timestamp.toDate() <= endDate);
            const filteredDespesas = despesas.filter(d => d.timestamp && d.timestamp.toDate() >= startDate && d.timestamp.toDate() <= endDate);
            
            const totalVendas = filteredVendas.reduce((sum, v) => sum + v.total, 0);
            const totalDespesas = filteredDespesas.reduce((sum, d) => sum + d.valor, 0);
            const faturamento = totalVendas - totalDespesas;

            document.getElementById('dashboard-vendas').textContent = formatCurrency(totalVendas);
            document.getElementById('dashboard-despesas').textContent = formatCurrency(totalDespesas);
            document.getElementById('dashboard-faturamento').textContent = formatCurrency(faturamento);
            
            renderDashboardDetails(filteredVendas);
        }

        function renderDashboardDetails(vendas) {
            const tableBody = document.getElementById('dashboard-vendas-detalhadas');
            tableBody.innerHTML = '';
            if (vendas.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhuma venda neste período.</td></tr>';
                return;
            }
            vendas.forEach(v => {
                const data = v.timestamp ? v.timestamp.toDate().toLocaleString('pt-BR') : '...';
                const itemsText = v.items.map(item => `${item.quantidade}x ${item.nome}`).join(', ');
                tableBody.innerHTML += `<tr><td class="p-2 border-b">${data}</td><td class="p-2 border-b">${itemsText}</td><td class="p-2 border-b">${v.formaPagamento || '-'}</td><td class="p-2 border-b text-right text-green-600">${formatCurrency(v.total)}</td></tr>`;
            });
        }

        // --- Lógica de Produtos ---
        function renderProdutosPage(produtos) {
            const acaiList = document.getElementById('lista-produtos-acai');
            const adicionaisList = document.getElementById('lista-produtos-adicionais');
            const sorveteList = document.getElementById('lista-produtos-sorvete');
            
            const acaiSelect = document.getElementById('acai-select');
            const adicionaisSelect = document.getElementById('adicionais-select');
            const sorveteSelect = document.getElementById('sorvete-select');
            
            acaiList.innerHTML = '';
            adicionaisList.innerHTML = '';
            sorveteList.innerHTML = '';
            acaiSelect.innerHTML = '<option value="" data-price="0">Selecione um Açaí</option>';
            adicionaisSelect.innerHTML = '<option value="" data-price="0">Selecione um Adicional</option>';
            sorveteSelect.innerHTML = '<option value="" data-price="0">Selecione um Sorvete</option>';

            const produtosPorCategoria = { 'Açaí': [], 'Adicionais': [], 'Sorvete': [] };
            produtos.forEach(p => {
                if (produtosPorCategoria[p.categoria]) {
                    produtosPorCategoria[p.categoria].push(p);
                }
            });

            const renderCategoryTable = (listElement, categoryName) => {
                if (produtosPorCategoria[categoryName].length === 0) {
                    listElement.innerHTML = '<p class="text-center p-4 text-gray-500">Nenhum produto nesta categoria.</p>';
                } else {
                    let tableHTML = '<table class="min-w-full divide-y divide-gray-200">';
                    produtosPorCategoria[categoryName].forEach(p => {
                        tableHTML += `<tr><td class="p-2 w-full">${p.nome}</td><td class="p-2 text-right">${formatCurrency(p.preco)}</td><td class="p-2 text-center whitespace-nowrap"><button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${p.id}" data-nome="${p.nome}" data-preco="${p.preco}" data-categoria="${p.categoria}"><i class="fas fa-edit"></i></button><button class="delete-btn text-red-500 hover:text-red-700" data-id="${p.id}" data-type="produtos"><i class="fas fa-trash"></i></button></td></tr>`;
                    });
                    tableHTML += '</table>';
                    listElement.innerHTML = tableHTML;
                }
            };

            renderCategoryTable(acaiList, 'Açaí');
            renderCategoryTable(adicionaisList, 'Adicionais');
            renderCategoryTable(sorveteList, 'Sorvete');

            produtos.forEach(p => {
                const option = `<option value="${p.nome}" data-price="${p.preco}">${p.nome}</option>`;
                if (p.categoria === 'Açaí') acaiSelect.innerHTML += option;
                if (p.categoria === 'Adicionais') adicionaisSelect.innerHTML += option;
                if (p.categoria === 'Sorvete') sorveteSelect.innerHTML += option;
            });
        }

        function resetProdutoForm() {
            document.getElementById('form-produto').reset();
            document.getElementById('produto-id-cadastro').value = '';
            document.getElementById('form-produto-title').textContent = 'Novo Produto';
            document.getElementById('form-produto-submit').textContent = 'Cadastrar Produto';
            document.getElementById('form-produto-cancel').classList.add('hidden');
        }

        document.getElementById('form-produto-cancel').addEventListener('click', resetProdutoForm);

        document.getElementById('produtos-page').addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                document.getElementById('produto-id-cadastro').value = editBtn.dataset.id;
                document.getElementById('produto-nome-cadastro').value = editBtn.dataset.nome;
                document.getElementById('produto-preco-cadastro').value = editBtn.dataset.preco;
                document.getElementById('produto-categoria-cadastro').value = editBtn.dataset.categoria;
                
                document.getElementById('form-produto-title').textContent = 'Editar Produto';
                document.getElementById('form-produto-submit').textContent = 'Salvar Alterações';
                document.getElementById('form-produto-cancel').classList.remove('hidden');
            }
        });

        // --- Lógica de Relatórios e Filtros ---
        function setupFilters() {
            const container = document.getElementById('dias-semana-filter');
            container.innerHTML = '';
            const dias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            dias.forEach((dia, index) => {
                container.innerHTML += `<div><input type="checkbox" id="dia-${index}" value="${index}" class="hidden filter-checkbox"><label for="dia-${index}" class="px-3 py-1 border rounded-full cursor-pointer transition">${dia}</label></div>`;
            });
            document.querySelectorAll('input[name="period"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('dias-semana-container').style.display = e.target.value === 'semanal' ? 'block' : 'none';
                });
            });
        }

        document.getElementById('filter-btn').addEventListener('click', () => {
            const period = document.querySelector('input[name="period"]:checked').value;
            let filteredVendas = [];
            let filteredDespesas = [];
            const now = new Date();
            document.getElementById('vendas-periodo-label').textContent = period;
            document.getElementById('despesas-periodo-label').textContent = period;
            
            let startDate, endDate;
            switch (period) {
                case 'semanal':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    
                    const selectedDays = [...document.querySelectorAll('.filter-checkbox:checked')].map(cb => parseInt(cb.value));
                    filteredVendas = currentVendas.filter(v => v.timestamp && v.timestamp.toDate() >= startDate && v.timestamp.toDate() <= endDate && selectedDays.includes(v.timestamp.toDate().getDay()));
                    filteredDespesas = currentDespesas.filter(d => d.timestamp && d.timestamp.toDate() >= startDate && d.timestamp.toDate() <= endDate && selectedDays.includes(d.timestamp.toDate().getDay()));
                    break;
                case 'mensal':
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    filteredVendas = currentVendas.filter(v => v.timestamp && v.timestamp.toDate().getMonth() === currentMonth && v.timestamp.toDate().getFullYear() === currentYear);
                    filteredDespesas = currentDespesas.filter(d => d.timestamp && d.timestamp.toDate().getMonth() === currentMonth && d.timestamp.toDate().getFullYear() === currentYear);
                    break;
                case 'anual':
                    const year = now.getFullYear();
                    filteredVendas = currentVendas.filter(v => v.timestamp && v.timestamp.toDate().getFullYear() === year);
                    filteredDespesas = currentDespesas.filter(d => d.timestamp && d.timestamp.toDate().getFullYear() === year);
                    break;
            }
            renderDetailedTables(filteredVendas, filteredDespesas);
        });
        
        function renderDetailedTables(vendas, despesas) {
            const vendasTbody = document.getElementById('vendas-detalhadas-table');
            const despesasTbody = document.getElementById('despesas-detalhadas-table');
            vendasTbody.innerHTML = '';
            despesasTbody.innerHTML = '';
            
            if (vendas.length === 0) vendasTbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhuma venda encontrada.</td></tr>';
            vendas.forEach(v => {
                const data = v.timestamp ? v.timestamp.toDate().toLocaleString('pt-BR') : '...';
                const itemsText = v.items.map(item => `${item.quantidade}x ${item.nome}`).join(', ');
                vendasTbody.innerHTML += `<tr><td class="p-2 border-b">${data}</td><td class="p-2 border-b">${itemsText}</td><td class="p-2 border-b">${v.formaPagamento || '-'}</td><td class="p-2 border-b text-right text-green-600">${formatCurrency(v.total)}</td><td class="p-2 border-b text-center"><button class="delete-btn text-red-500 hover:text-red-700" data-id="${v.id}" data-type="vendas"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            if (despesas.length === 0) despesasTbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhuma despesa encontrada.</td></tr>';
            despesas.forEach(d => {
                const data = d.timestamp ? d.timestamp.toDate().toLocaleString('pt-BR') : '...';
                despesasTbody.innerHTML += `<tr><td class="p-2 border-b">${data}</td><td class="p-2 border-b">${d.descricao}</td><td class="p-2 border-b text-right text-red-600">${formatCurrency(d.valor)}</td><td class="p-2 border-b text-center"><button class="delete-btn text-red-500 hover:text-red-700" data-id="${d.id}" data-type="despesas"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- Lógica do Modal e Exclusão ---
        function showModal(onConfirm) {
            modal.classList.remove('hidden');
            deleteFunction = onConfirm;
        }
        function hideModal() {
            modal.classList.add('hidden');
            deleteFunction = null;
        }
        document.getElementById('modal-cancel-btn').addEventListener('click', hideModal);
        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            if (deleteFunction) {
                deleteFunction();
            }
            hideModal();
        });

        document.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const type = deleteBtn.dataset.type;
                showModal(() => deleteItem(type, id));
            }
        });

        // --- Navegação e Download PDF ---
        const menuItems = document.querySelectorAll('.menu-item');
        const pages = document.querySelectorAll('.page-content');
        menuItems.forEach(item => { item.addEventListener('click', e => { e.preventDefault(); const pageId = item.dataset.page + '-page'; menuItems.forEach(i => i.classList.remove('menu-active')); item.classList.add('menu-active'); pages.forEach(p => p.classList.toggle('hidden', p.id !== pageId)); }); });
        
        document.getElementById('download-pdf-btn').addEventListener('click', () => {
            document.getElementById('pdf-options-modal').classList.remove('hidden');
        });
        document.getElementById('pdf-options-cancel-btn').addEventListener('click', () => {
            document.getElementById('pdf-options-modal').classList.add('hidden');
        });
        document.querySelectorAll('.pdf-download-option').forEach(button => {
            button.addEventListener('click', (e) => {
                const period = e.target.dataset.period;
                generatePDF(period);
                document.getElementById('pdf-options-modal').classList.add('hidden');
            });
        });

        function generatePDF(period) {
            loadingOverlay.classList.remove('hidden');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

            let title, startDate, endDate;
            const now = new Date();

            switch (period) {
                case 'diario':
                    title = 'Relatório Diário';
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'semanal':
                    title = 'Relatório Semanal';
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'mensal':
                    title = 'Relatório Mensal';
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'anual':
                    title = 'Relatório Anual';
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
            }

            const filteredVendas = currentVendas.filter(v => v.timestamp && v.timestamp.toDate() >= startDate && v.timestamp.toDate() <= endDate);
            const filteredDespesas = currentDespesas.filter(d => d.timestamp && d.timestamp.toDate() >= startDate && d.timestamp.toDate() <= endDate);
            
            const totalVendas = filteredVendas.reduce((sum, v) => sum + v.total, 0);
            const totalDespesas = filteredDespesas.reduce((sum, d) => sum + d.valor, 0);
            const faturamento = totalVendas - totalDespesas;

            pdf.setFontSize(18);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Relatório de Faturamento - Açaí do Felps', 105, 15, { align: 'center' });

            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`${title}: ${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}`, 105, 22, { align: 'center' });
            
            pdf.autoTable({
                startY: 30,
                head: [['Descrição', 'Valor']],
                body: [
                    ['Total de Vendas', formatCurrency(totalVendas)],
                    ['Total de Despesas', formatCurrency(totalDespesas)],
                    ['Faturamento (Lucro)', formatCurrency(faturamento)],
                ],
                theme: 'grid',
                headStyles: { fillColor: [76, 29, 149] },
                bodyStyles: { fontStyle: 'bold' }
            });

            let finalY = pdf.autoTable.previous.finalY;

            if (filteredVendas.length > 0) {
                pdf.autoTable({
                    startY: finalY + 10,
                    head: [['Data/Hora', 'Itens', 'Pagamento', 'Valor Total']],
                    body: filteredVendas.map(v => [v.timestamp.toDate().toLocaleString('pt-BR'), v.items.map(item => `${item.quantidade}x ${item.nome}`).join(', '), v.formaPagamento || '-', formatCurrency(v.total)]),
                    theme: 'striped',
                    headStyles: { fillColor: [76, 29, 149] },
                });
                finalY = pdf.autoTable.previous.finalY;
            }

            if (filteredDespesas.length > 0) {
                 pdf.autoTable({
                    startY: finalY + 10,
                    head: [['Data/Hora', 'Descrição', 'Valor']],
                    body: filteredDespesas.map(d => [d.timestamp.toDate().toLocaleString('pt-BR'), d.descricao, formatCurrency(d.valor)]),
                    theme: 'striped',
                    headStyles: { fillColor: [220, 38, 38] },
                });
            }

            pdf.save(`relatorio-${period}-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
            loadingOverlay.classList.add('hidden');
        }
        
        // --- Lógica do Menu Mobile ---
        const sidebar = document.getElementById('sidebar');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');

        function toggleMenu() {
            sidebar.classList.toggle('-translate-x-full');
            mobileMenuOverlay.classList.toggle('hidden');
        }

        mobileMenuButton.addEventListener('click', toggleMenu);
        mobileMenuOverlay.addEventListener('click', toggleMenu);
        
        // --- Lógica das Abas de Registro ---
        const tabVendaBtn = document.getElementById('tab-venda-btn');
        const tabDespesaBtn = document.getElementById('tab-despesa-btn');
        const tabVendaContent = document.getElementById('tab-venda-content');
        const tabDespesaContent = document.getElementById('tab-despesa-content');

        tabVendaBtn.addEventListener('click', () => {
            tabVendaBtn.classList.add('text-purple-600', 'border-purple-600');
            tabVendaBtn.classList.remove('text-gray-500', 'border-transparent');
            tabDespesaBtn.classList.add('text-gray-500', 'border-transparent');
            tabDespesaBtn.classList.remove('text-purple-600', 'border-purple-600');
            tabVendaContent.classList.remove('hidden');
            tabDespesaContent.classList.add('hidden');
        });

        tabDespesaBtn.addEventListener('click', () => {
            tabDespesaBtn.classList.add('text-purple-600', 'border-purple-600');
            tabDespesaBtn.classList.remove('text-gray-500', 'border-transparent');
            tabVendaBtn.classList.add('text-gray-500', 'border-transparent');
            tabVendaBtn.classList.remove('text-purple-600', 'border-purple-600');
            tabDespesaContent.classList.remove('hidden');
            tabVendaContent.classList.add('hidden');
        });

        // --- Lógica das Abas de Produtos ---
        const productTabs = document.querySelectorAll('.product-tab');
        const productLists = document.querySelectorAll('.product-list');

        productTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                productTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const category = tab.dataset.category;
                productLists.forEach(list => {
                    if (list.id === `lista-produtos-${category.toLowerCase()}`) {
                        list.classList.remove('hidden');
                    } else {
                        list.classList.add('hidden');
                    }
                });
            });
        });

    </script>
</body>
</html>
